<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Simple Split Bill</title>

    <link rel="icon" href="favicon-16.png" sizes="16x16" />
    <link rel="icon" href="favicon-32.png" sizes="32x32" />
    <link rel="icon" href="favicon-96.png" sizes="96x96" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css" rel="stylesheet" />
    <link href="site.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js" defer></script>
    <script src="site.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  </head>

  <body>
    <div class="container" x-data="spill">
      <div class="my-4">
        <h1 class="fs-4 fw-bold">Simple Split Bill</h1>
        <h6 class="fs-7 text-secondary">Simply put the grand total, then list the items</h6>
      </div>

      <div class="mt-3">
        <label for="totalInput" class="form-label fw-bold">Grand Total</label>
        <input id="totalInput" type="number" class="form-control" x-model="total" @focus="select" />
      </div>
      <div class="mt-3">
        <label for="itemsInput" class="form-label fw-bold c-help" title="Format: {price} {person} {person} - {comment}">
          Items<span class="ms-1 fw-normal">&#9432;</span>
        </label>
        <textarea id="itemsInput" class="form-control" rows="3" x-model="items" @focus="select"></textarea>
      </div>
      <div class="mt-3">
        <label class="form-label fw-bold">Breakdown</label>
        <template x-if="error">
          <div class="text-danger" x-text="error"></div>
        </template>
        <template x-if="billData">
          <div class="table-responsive">
            <table class="table table-sm table-bordered mb-0 fs-7 text-end bg-white">
              <tr class="table-dark">
                <th class="text-start">ITEM</th>
                <th>PRICE</th>
                <th>W.&nbsp;FEE&nbsp;(<span x-text="formatNumber(billData?.feePercentage)"></span>%)</th>
                <template x-for="person in billData?.people">
                  <th x-text="person"></th>
                </template>
              </tr>
              <template x-for="item in billData?.items">
                <tr>
                  <td class="table-light text-start" x-text="item.no"></td>
                  <td class="table-light" x-text="formatNumber(item.price)"></td>
                  <td class="table-light" x-text="formatNumber(item.priceWithFee)"></td>
                  <template x-for="person in billData?.people">
                    <td x-text="formatNumber(item.people[person])"></td>
                  </template>
                </tr>
              </template>
              <tr>
                <th class="table-light text-start">TOTAL</th>
                <th
                  class="table-light c-help"
                  title="Sum of item prices"
                  x-text="formatNumber(billData?.totalPrice)"
                ></th>
                <th
                  class="table-light c-help"
                  title="Might differ from the total above due to rounding"
                  x-text="formatNumber(billData?.totalPriceWithFee)"
                ></th>
                <template x-for="person in billData?.people">
                  <th class="table-warning" x-text="formatNumber(billData?.peopleTotal[person])"></th>
                </template>
              </tr>
            </table>
          </div>
        </template>
      </div>
      <div class="mt-3">
        <button class="btn btn-sm btn-secondary" type="button" @click="copy">&#128203;&nbsp;&nbsp;Summary</button>
        <button class="btn btn-sm btn-secondary" type="button" @click="share">&#128279;&nbsp;&nbsp;Link</button>
      </div>

      <div class="my-4">
        <div class="accordion" id="accordionMBR">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button
                class="accordion-button text-bg-light fs-7 py-2 px-3 collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseMBR"
              >
                <span class="badge text-bg-warning me-2">Advanced</span>
                Stack Bills
              </button>
            </h2>
            <div id="collapseMBR" class="accordion-collapse collapse" data-bs-parent="#accordionMBR">
              <div class="accordion-body">
                <div class="btn btn-sm btn-secondary" @click="mbrSave">&#128190;&nbsp;&nbsp;Save</div>
                <div class="btn btn-sm btn-link text-danger" @click="mbrClear">Clear</div>

                <template x-if="mbrData.people.length">
                  <div>
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered mt-3 mb-0 fs-7 text-end bg-white">
                        <tr class="table-dark">
                          <th class="text-start">BILL</th>
                          <th>TOTAL</th>
                          <template x-for="person in mbrData.people">
                            <th x-text="person"></th>
                          </template>
                        </tr>
                        <template x-for="(bill, billIndex) in mbrData.bills">
                          <tr>
                            <td class="table-light text-start" x-text="bill.note || billIndex + 1"></td>
                            <td class="table-light" x-text="formatNumber(bill.totalPriceWithFee)"></td>
                            <template x-for="person in mbrData.people">
                              <td>
                                <span
                                  class="badge rounded-pill text-bg-secondary c-help"
                                  title="This person paid this bill"
                                  x-show="bill.payer === person"
                                >
                                  P
                                </span>
                                <span
                                  x-text="bill.peopleTotal[person] ? formatNumber(bill.peopleTotal[person]) : ''"
                                ></span>
                              </td>
                            </template>
                          </tr>
                        </template>
                        <tr class="table-light">
                          <th class="text-start c-help" colspan="2" title="Total paid for others">CREDIT</th>
                          <template x-for="balance in mbrGetBalance()">
                            <th x-text="formatNumber(balance.credit)"></th>
                          </template>
                        </tr>
                        <tr class="table-light">
                          <th class="text-start c-help" colspan="2" title="Total owed to others">DEBT</th>
                          <template x-for="balance in mbrGetBalance()">
                            <th x-text="formatNumber(balance.debt)"></th>
                          </template>
                        </tr>
                        <tr class="table-light">
                          <th class="text-start c-help" colspan="2" title="Credit - debt">BALANCE</th>
                          <template x-for="balance in mbrGetBalance()">
                            <th class="table-warning" x-text="formatNumber(balance.credit - balance.debt)"></th>
                          </template>
                        </tr>
                      </table>
                    </div>
                    <div class="mt-3">
                      <label
                        class="form-label fw-bold c-help"
                        title="Minimize transfers by matching top creditors with top debtors"
                      >
                        Settlement<span class="ms-1 fw-normal">&#9432;</span>
                      </label>
                      <ul class="fs-7">
                        <template x-for="transaction in mbrSettle()">
                          <li>
                            <span class="fw-bold" x-text="transaction.from"></span>
                            &rarr;
                            <span class="fw-bold" x-text="transaction.to"></span>:
                            <span x-text="formatNumber(transaction.amount)"></span>
                          </li>
                        </template>
                      </ul>
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-sm btn-secondary" type="button" @click="mbrCopy">
                        &#128203;&nbsp;&nbsp;Summary
                      </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
